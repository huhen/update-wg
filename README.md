# Система маршрутизации трафика через WireGuard

## Описание

Система позволяет направлять трафик через WireGuard туннель только для определенных IP-адресов, оставляя остальной трафик через основной интерфейс.

## Принцип работы

1. Скрипт `update-wg-ipset.py` получает список российских IP-адресов из RIPE
2. Исключает локальные и специальные сети (из `exclude.txt`)
3. Добавляет исключения из `include.txt` (имеют приоритет)
4. Создает разницу между всеми IPv4 исключениями, получая список разрешенных IP-адресов
5. Создает ipset с разрешенными IP-адресами
6. Настраивает iptables для маркировки трафика в разрешенные IP-адреса
7. Настраивает политику маршрутизации для направления помеченного трафика через WireGuard

## Конфигурация WireGuard

В отличие от традиционного подхода, в WireGuard конфигурации:

- Установлен `Table = off` для отключения автоматической маршрутизации
- Установлен `AllowedIPs = 0.0.0.0/1, 128.0.0.0/1` для разрешения всего IPv4 трафика через туннель
- Маршрутизацией управляет iptables + политика маршрутизации

## Файлы конфигурации

- `exclude.txt` - список сетей для исключения из маршрутизации через WireGuard
- `include.txt` - список сетей для принудительного включения в маршрутизацию через WireGuard (имеет приоритет)
- `/etc/wireguard/wg1.conf` - конфигурация WireGuard

## Скрипты

- `update-wg-ipset.py` - основной скрипт обновления конфигурации
- `diagnose-routing.py` - скрипт диагностики текущего состояния системы

## Установка

1. Убедитесь, что установлены зависимости: `ipset`, `iptables`, `wireguard-tools`, `iproute2`
2. Настройте конфигурацию WireGuard в `/etc/wireguard/wg1.conf`
3. Запустите `sudo python3 update-wg-ipset.py`

## Диагностика

Для диагностики текущего состояния системы запустите:
```
sudo python3 diagnose-routing.py
